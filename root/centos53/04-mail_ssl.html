<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf8" />
    <title>通信内容暗号化 | How to Linode</title>
    <meta name="keywords" content="" />
    <meta name="description" content="メールの送受信を行う際に、ユーザー名、パスワードが盗聴されないように両者の間での通信内容を暗号化します。" />
    <meta name="robots" content="all" />

    <link rel="stylesheet" type="text/css" media="screen" href="../common/css/import.css"/>
</head>
<body>
	<div id="wrapper">
		<div id="wrap">
			<div id="header">
				<p id="title"><a href="/">How to Linode</a></p>
			</div>
<!-- category[start] -->
<ul id="tab">
<li><a href="/" class="home">HOME</a></li>
<li><a href="/centos53/" class="centos53 current">CentOS5.3</a></li>
<li><a href="/debian50/" class="debian50">Debian5.0</a></li>
</ul>
<!-- category[end] -->

<!-- bread[start] -->
<p id="bread">
<a href="/">home</a> &gt;
<a href="/centos53">centos53</a> &gt;
通信内容暗号化
</p>
<!-- bread[end] -->

			<div id="side-bar">
<!-- menu[start] -->
<h3>初期設定</h3>
<ul class="menu">
    <li><a href="index.html">OS起動</a></li>
    <li><a href="02-ssh.html">OpenSSH設定</a></li>
    <li><a href="02-yum.html">yum最適化</a></li>
    <li><a href="02-sudo.html">sudo導入</a></li>
    <li><a href="02-vim.html">vi拡張</a></li>
    <li><a href="02-screen.html">screen導入</a></li>
    <li><a href="02-zsh.html">zsh導入</a></li>
    <li><a href="02-ntpd.html">日付設定</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>Webサーバー構築</h3>
<ul class="menu">
    <li><a href="03-virtualhost.html">バーチャルホスト設定</a></li>
    <li><a href="03-htdigest.html">認証ページ作成</a></li>
    <li><a href="03-ssl.html">SSL通信</a></li>
    <li><a href="03-fcgi.html">FCGI</a></li>
    <li><a href="03-memcache.html">mamcache</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>メールサーバー構築</h3>
<ul class="menu">
    <li><a href="04-postfix.html">Postifx</a></li>
    <li><a href="04-dovecot.html">dovecot</a></li>
    <li><a href="04-mail_ssl.html">通信内容暗号化</a></li>
    <li><a href="04-mailx.html">mailコマンド導入</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>セキュリティ強化</h3>
<ul class="menu">
    <li><a href="05-tripwire.html">Tripwire</a></li>
    <li><a href="05-chkrootkit.html">chkrootkit</a></li>
    <li><a href="05-snort.html">Snort + Oinkmaster</a></li>
    <li><a href="05-swatch.html">SWATCH</a></li>
    <li><a href="05-clam.html">Clam AntiVirus</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>DBサーバー構築</h3>
<ul class="menu">
    <li><a href="06-mysql.html">MySQL導入</a></li>
    <li><a href="06-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>開発者向けツール導入</h3>
<ul class="menu">
    <li><a href="07-subversion.html">subversion</a></li>
    <li><a href="07-trac.html">Trac</a></li>
    <li><a href="07-hotcopy_svn_trac.html">Trac & SVN バックアップ</a></li>
    <li><a href="07-git.html">git</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>バックアップ強化</h3>
<ul class="menu">
    <li><a href="08-backup.html">自動バックアップ</a></li>
    <li><a href="08-subversion.html">MySQL導入</a></li>
    <li><a href="08-cwRsync.html">rsyncクライアント導入</a></li>
    <li><a href="08-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

			</div>
		    <div id="content">
		        <h1 id="通信内容暗号化">通信内容暗号化</h1>
<p id="description">メールの送受信を行う際に、ユーザー名、パスワードが盗聴されないように両者の間での通信内容を暗号化します。</p>
<h2 id="パッケージの確認">パッケージの確認</h2>
<pre class="wiki">
% sudo rpm -qa grep cyrus-sasl*

cyrus-sasl-lib-2.1.22-4
cyrus-sasl-2.1.22-4
cyrus-sasl-plain-2.1.22-4
cyrus-sasl-md5-2.1.22-4
</pre>
<p>
おそらく「zsh: no matches found: cyrus-sasl*」などと表示されるので、このようにパッケージが不足している場合はyum installを行ってください。
</p>
<pre class="wiki">
% sudo yum -y install 'cyrus-sasl*'
</pre>
<h2 id="サーバー証明書作成">サーバー証明書作成</h2>
<p>
</p>
<p>
ディレクトリ移動
</p>
<pre class="wiki">
% cd /etc/pki/tls/certs/
</pre>
<p>
サーバー証明書作成
</p>
<pre class="wiki">
% sudo make mail.pem
</pre>
<p>
次の質問に回答
</p>
<pre class="wiki">
Country Name ( 2 letter code ) [GB]:			JP
State or Province Name ( full name ) [Berkshire]:		Tokyo
Locality Name ( eg, city ) [Newbury]:			Shibuya
Organization Name ( eg, company ) [My Company Ltd]	空エンター
Organizational Unit Name ( eg, section ) []		空エンター
Common Name ( eg, your name or your server's hostname ) []:	mail.linode.jp
Email Address []:					admin@mail.linode.jp
</pre>
<h2 id="Postfix設定">Postfix設定</h2>
<h3 id="main設定ファイル編集">main設定ファイル編集</h3>
<p>
該当するファイルを開く
</p>
<pre class="wiki">
% sudo vi /etc/postfix/main.cf
</pre>
<p>
以下を最終行に追加(TLS通信の有効化)
</p>
<pre class="wiki">
smtpd_use_tls = yes
smtpd_tls_cert_file = /etc/pki/tls/certs/mail.pem
smtpd_tls_key_file = /etc/pki/tls/certs/mail.pem
smptd_tls_session_cache_database = btree:/etc/postfix/smtpd_scache
</pre>
<h2 id="master設定ファイル編集">master設定ファイル編集</h2>
<p>
該当するファイルを開く
</p>
<pre class="wiki">
% sudo vi /etc/postfix/master.cf
</pre>
<p>
以下の項目を有効にする(コメントオフを解除)
</p>
<pre class="wiki">
smtps      inet  n       -       n       -       -       smtpd
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
</pre>
<p>
postfix 再起動
</p>
<pre class="wiki">
% sudo /sbin/service postfix restart
</pre>
<p>
telnetなどで通信可能な状態であることを確認
</p>
<h2 id="Dovecot設定">Dovecot設定</h2>
<h3 id="設定ファイル編集">設定ファイル編集</h3>
<p>
該当するファイルを開きます。
</p>
<pre class="wiki">
% sudo vi /etc/dovecot.conf
</pre>
<p>
以下の項目を編集し、TLS通信を有効にします。
</p>
<pre class="wiki">
ssl_disable = no
</pre>
<p>
以下の項目を編集し、サーバー証明書の所在を指定します。
</p>
<pre class="wiki">
ssl_cert_file = /etc/pki/tls/certs/mail.pem
ssl_key_file = /etc/pki/tls/certs/mail.pem
</pre>
<h2 id="Dovecot再起動">Dovecot再起動</h2>
<pre class="wiki">
% sudo /sbin/service dovecot restart
</pre>
<h2 id="サーバー証明書のインポート">サーバー証明書のインポート</h2>
<p>
上記の設定でサーバーとクライアント間の通信は暗号化されていますが、警告ウィンドウが表示されると思います。
この表示を回避するために、インポート用サーバー証明書を作成します。
</p>
<h3 id="サーバー証明書を作成">サーバー証明書を作成</h3>
<p>
ディレクトリ移動
% sudo cd /etc/pki/tls/certs
% sudo openssl x509 -in mail.pem -outform DER -out mail.der
</p>
<p>
作成されたmail.derをクライアント側のメールソフトへインポートします。windows上でダブルクリックすればよいでしょう。
</p>
<p>
postfixで使用するプロトコルも制限しておきます。
</p>
<pre class="wiki">
% sudo vi /etc/postfix/master.cf
</pre>
<pre class="wiki">
# smtp      inet  n       -       n       -       -       smtpd	←	コメントアウト
</pre>
<p>
再起動
</p>
<pre class="wiki">
% /sbin/service postfix restart
</pre>
<p>
同じくdovecotで使用するプロトコルも制限しておきます。
</p>
<pre class="wiki">
% sudo vi /etc/dovecot.conf
</pre>
<pre class="wiki">
protocols = imaps
</pre>
<p>
再起動
</p>
<pre class="wiki">
% sudo /sbin/service dovecot restart
</pre>
<h2 id="メールソフト設定">メールソフト設定</h2>
<p>
Thunderbirdの場合
</p>
<table>
<tr><td> あなたの名前 </td><td> linode.jp </td></tr>
<tr><td> メールアドレス </td><td> admin@mail.linode.jp </td></tr>
<tr><td> メール受信サーバーの種類 </td><td> IMAP </td></tr>
<tr><td> メール受信サーバー </td><td> mail.linode.jp </td></tr>
<tr><td> 共通受信トレイ </td><td> 使用しない </td></tr>
<tr><td> 受信サーバのユーザ名 </td><td> admin </td></tr>
<tr><td> アカウント名 </td><td> admin@mail.linode.jp </td></tr>
</table>
<p>
設定後はSSLを使用するにチェックをつける
</p>

		    </div>
			<br class="clear" />
			<div id="footer">
				<p>
					<a href="http://linode.jp">Linode</a> | 
					<a href="http://www.add9.biz/phpunit">PHPUnit</a> | 
					<a href="http://www.add9.biz/symfony">Symfony</a>
					<br />
				
					<a href="http://www.add9.biz/c">C</a> | 
					<a href="http://www.add9.biz/moose">Moose</a> | 
					<a href="http://www.add9.biz/design_pattern">Design Pattern</a>
					<br />

					<a href="http://www.add9.biz/jump">Jump Attack Forum</a> | 
					<a href="http://dancepod.tv">DancePod.tv</a>
				</p>
			</div>
	    </div>
		<div id="adsence">
			<script type="text/javascript"><!--
			google_ad_client = "pub-3627018862025650";
			google_ad_slot = "0294735282";
			google_ad_width = 160;
			google_ad_height = 600;
			//-->
			</script>
			<script type="text/javascript"
			src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
			</script>
		</div>
	</div>
	<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
	try {
	var pageTracker = _gat._getTracker("UA-7965172-1");
	pageTracker._trackPageview();
	} catch(err) {}</script>
</body>
</html>
