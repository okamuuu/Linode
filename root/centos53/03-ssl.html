<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf8" />
    <title>SSL通信 | How to Linode</title>
    <meta name="keywords" content="make" />
    <meta name="description" content="SSLは暗号化してやり取りするやり方の決まりです。Apacheのモジュールを使用してこの通信を暗号化します。" />
    <meta name="robots" content="all" />

    <link rel="stylesheet" type="text/css" media="screen" href="../common/css/import.css"/>
</head>
<body>
	<div id="wrapper">
		<div id="wrap">
			<div id="header">
				<p id="title"><a href="/">How to Linode</a></p>
			</div>
<!-- category[start] -->
<ul id="tab">
<li><a href="/" class="home">HOME</a></li>
<li><a href="/centos53/" class="centos53 current">CentOS5.3</a></li>
<li><a href="/debian50/" class="debian50">Debian5.0</a></li>
</ul>
<!-- category[end] -->

<!-- bread[start] -->
<p id="bread">
<a href="/">home</a> &gt;
SSL通信
</p>
<!-- bread[end] -->

			<div id="side-bar">
<!-- menu[start] -->
<h3>初期設定</h3>
<ul class="menu">
    <li><a href="index.html">OS起動</a></li>
    <li><a href="02-ssh.html">OpenSSH設定</a></li>
    <li><a href="02-yum.html">yum最適化</a></li>
    <li><a href="02-sudo.html">sudo導入</a></li>
    <li><a href="02-vim.html">vi拡張</a></li>
    <li><a href="02-screen.html">screen導入</a></li>
    <li><a href="02-zsh.html">zsh導入</a></li>
    <li><a href="02-ntpd.html">日付設定</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>Webサーバー構築</h3>
<ul class="menu">
    <li><a href="03-virtualhost.html">バーチャルホスト設定</a></li>
    <li><a href="03-htdigest.html">認証ページ作成</a></li>
    <li><a href="03-ssl.html">SSL通信</a></li>
    <li><a href="03-fcgi.html">FCGI</a></li>
    <li><a href="03-memcache.html">mamcache</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>メールサーバー構築</h3>
<ul class="menu">
    <li><a href="04-postfix.html">Postifx</a></li>
    <li><a href="04-dovecot.html">dovecot</a></li>
    <li><a href="04-mailx.html">mailコマンド導入</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>セキュリティ強化</h3>
<ul class="menu">
    <li><a href="05-tripwire.html">Tripwire</a></li>
    <li><a href="05-chkrootkit.html">chkrootkit</a></li>
    <li><a href="05-snort.html">Snort + Oinkmaster</a></li>
    <li><a href="05-swatch.html">SWATCH</a></li>
    <li><a href="05-clam.html">Clam AntiVirus</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>DBサーバー構築</h3>
<ul class="menu">
    <li><a href="06-mysql.html">MySQL導入</a></li>
    <li><a href="06-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>開発者向けツール導入</h3>
<ul class="menu">
    <li><a href="07-subversion.html">subversion</a></li>
    <li><a href="07-trac.html">Trac</a></li>
    <li><a href="07-hotcopy_svn_trac.html">Trac & SVN バックアップ</a></li>
    <li><a href="07-git.html">git</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>バックアップ強化</h3>
<ul class="menu">
    <li><a href="08-backup.html">自動バックアップ</a></li>
    <li><a href="08-subversion.html">MySQL導入</a></li>
    <li><a href="08-cwRsync.html">rsyncクライアント導入</a></li>
    <li><a href="08-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

			</div>
		    <div id="content">
		        <h1 id="SSL通信">SSL通信</h1>
<p id="description">SSLは暗号化してやり取りするやり方の決まりです。Apacheのモジュールを使用してこの通信を暗号化します。</p>
<h2 id="作業内容">作業内容</h2>
<p>
この章では「<a class="ext-link" href="https://ssltest.mydomain"><span class="icon"></span>https://ssltest.mydomain</a>」との通信を行う場合を想定し、次の作業を行います。
</p>
<ul><li>SSLコンテンツ公開用ディレクトリを設置
</li><li>sslモジュールのインストール
</li><li>証明書の有効期限を変更
</li><li>CA用秘密鍵、証明書を作成
</li><li>サーバー用秘密鍵を作成
</li><li>署名要求書の作成
</li><li>サーバー用秘密鍵からパスフレーズを削除
</li><li>サーバー用証明書の作成</li></ul>
<h2 id="SSLコンテンツ公開用ディレクトリを設置">SSLコンテンツ公開用ディレクトリを設置</h2>
<pre class="wiki">
% mkdir -p ~/Prj/SSLTEST/root ~/Prj/SSLTEST/logs
% echo 'ssltest' &gt;&gt;  ~/Prj/SSLTEST/root/index.html
</pre>
<h2 id="modsslインストール">mod_sslインストール</h2>
<pre class="wiki">
% sudo yum -y install mod_ssl
</pre>
<h2 id="証明書の有効期限を変更">証明書の有効期限を変更</h2>
<p>
Makefileにサーバー用証明有効期限が365日になっている箇所があります。
テストサーバーの意味合いが強いWEBサーバーを構築するため、これを3650 日(10年)に変更します。
</p>
<pre class="wiki">
% sudo sed -i 's/365/3650/g' /etc/pki/tls/certs/Makefile
</pre>
<h2 id="サーバー用秘密鍵・証明書(server.crt)作成">サーバー用秘密鍵・証明書(server.crt)作成</h2>
<p>
<em>make</em>コマンドの有無を確かめます。
</p>
<pre class="wiki">
% sudo yum list | grep make

automake.noarch                          1.9.6-2.1                     base
automake14.noarch                        1.4p6-13                      base
automake15.noarch                        1.5-16                        base
automake16.noarch                        1.6.3-8                       base
automake17.noarch                        1.7.9-7                       base
imake.i386                               1.0.2-3                       base
make.i386                                1:3.81-3.el5                  base
</pre>
<h3 id="インストール">インストール</h3>
<pre class="wiki">
% sudo yum -y install make
</pre>
<pre class="wiki">
% cd /etc/pki/tls/certs/
% sudo make ssltest.server.crt

Enter pass phrase:		←パスワードを適当に入力。ssltest
Verifying - Enter pass phrase:		←再入力
Enter pass phrase for server.key:	←再々入力
Country Name (2 letter code) [GB]:	JP
State or Province Name (full name) [Berkshire]:	Tokyo
Locality Name (eg, city) [Newbury]:	Shibuya
Organization Name (eg, company) [My Company Ltd]:	適当に
Organizational Unit Name (eg, section) []:			適当に
Common Name (eg, your name or your server's hostname) []:	ssltest.mydomain
Email Address []:		webmaster@mydomain
</pre>
<p>
SSL設定。/etc/httpd/conf.d/ssl.confのVirtualHostディレクティブをすべてコメントアウト
</p>
<p>
{{
% sudo vi /etc/httpd/conf.d/ssl.conf
}}
# &lt;<a class="wiki" href="/wiki/VirtualHost">VirtualHost</a> _default_:443&gt;
#…
#…
#&lt;/VirtualHost&gt;
}}
</p>
<p>
次に/etc/httpd/conf/httpd.confにSSLの設定内容を追加
</p>
<pre class="wiki">
% sudo vi /etc/http/conf/httpd.conf
</pre>
<pre class="wiki">
&lt;VirtualHost *:443&gt;
    ServerName ssltest.irc-web01
    DocumentRoot /home/homepage/Prj/SSLTEST/root
    CustomLog &quot;| /usr/sbin/rotatelogs /home/homepage/Prj/SSLTEST/logs/ssltest_access_log.%Y%m%d 86400 540&quot; combined env=!static_files
    ErrorLog  &quot;| /usr/sbin/rotatelogs /home/homepage/Prj/SSLTEST/logs/ssltest_error_log.%Y%m%d 86400 540&quot;
    SSLEngine on
    SSLProtocol all -SSLv2
    SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW

    SSLCertificateFile /etc/pki/tls/certs/ssltest.server.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/ssltest.server.key

    &lt;Files ~ &quot;\.(cgi|shtml|phtml|php3?)$&quot;&gt;
        SSLOptions +StdEnvVars
    &lt;/Files&gt;
    SetEnvIf User-Agent &quot;.*MSIE.*&quot; \
         nokeepalive ssl-unclean-shutdown \
         downgrade-1.0 force-response-1.0
&lt;/VirtualHost&gt;
</pre>
<p>
サーバーを再起動するとパス・フレーズの入力を求められる。
<tt>
% sudo /sbin/service httpd restart
httpd を停止中:                                            [  OK  ]
httpd を起動中: Apache/2.2.3 mod_ssl/2.2.3 (Pass Phrase Dialog)
Some of your private key files are encrypted for security reasons.
In order to read them you have to provide the pass phrases.
Server irc-web01:443 (RSA)
Enter pass phrase:
</p>
<p>
<tt>
</p>
<p>
WEBサーバー起動時にパスワードを要求しなで自動的に起動してほしいのでパスワードを削除します。 
</p>
<pre class="wiki">
% pwd
/etc/pki/tls/certs

% sudo openssl rsa -in ssltest.server.key -out ssltest.server.key
</pre>
<p>
再起動してパスワードが要求されない事を確認します。
<a class="ext-link" href="https://"><span class="icon"></span>https://</a> で接続できることを確認します。
</p>
<h2 id="ポート確認">ポート確認</h2>
<pre class="wiki">
% nmap localhost | grep 443
443/tcp open  https
</pre>

		    </div>
			<br class="clear" />
			<div id="footer">
				<p>
					<a href="http://linode.jp">Linode</a> | 
					<a href="http://www.add9.biz/phpunit">PHPUnit</a> | 
					<a href="http://www.add9.biz/symfony">Symfony</a>
					<br />
				
					<a href="http://www.add9.biz/c">C</a> | 
					<a href="http://www.add9.biz/moose">Moose</a> | 
					<a href="http://www.add9.biz/design_pattern">Design Pattern</a>
					<br />

					<a href="http://www.add9.biz/jump">Jump Attack Forum</a> | 
					<a href="http://dancepod.tv">DancePod.tv</a>
				</p>
			</div>
	    </div>
		<div id="adsence">
			<script type="text/javascript"><!--
			google_ad_client = "pub-3627018862025650";
			google_ad_slot = "0294735282";
			google_ad_width = 160;
			google_ad_height = 600;
			//-->
			</script>
			<script type="text/javascript"
			src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
			</script>
		</div>
	</div>
	<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
	try {
	var pageTracker = _gat._getTracker("UA-7965172-1");
	pageTracker._trackPageview();
	} catch(err) {}</script>
</body>
</html>
