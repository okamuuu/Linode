<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf8" />
    <title>自動バックアップ | How to Linode</title>
    <meta name="keywords" content="" />
    <meta name="description" content="バックアップ対象ディレクトリを、tarコマンドで圧縮してバックアップ先ディレクトリへ保存します。" />
    <meta name="robots" content="all" />

    <link rel="stylesheet" type="text/css" media="screen" href="../common/css/import.css"/>
</head>
<body>
	<div id="wrapper">
		<div id="wrap">
			<div id="header">
				<p id="title"><a href="/">How to Linode</a></p>
			</div>
<!-- category[start] -->
<ul id="tab">
<li><a href="/" class="home">HOME</a></li>
<li><a href="/centos53/" class="centos53 current">CentOS5.3</a></li>
<li><a href="/debian50/" class="debian50">Debian5.0</a></li>
</ul>
<!-- category[end] -->

<!-- bread[start] -->
<p id="bread">
<a href="/">home</a> &gt;
自動バックアップ
</p>
<!-- bread[end] -->

			<div id="side-bar">
<!-- menu[start] -->
<h3>初期設定</h3>
<ul class="menu">
    <li><a href="index.html">OS起動</a></li>
    <li><a href="02-ssh.html">OpenSSH設定</a></li>
    <li><a href="02-yum.html">yum最適化</a></li>
    <li><a href="02-sudo.html">sudo導入</a></li>
    <li><a href="02-vim.html">vi拡張</a></li>
    <li><a href="02-screen.html">screen導入</a></li>
    <li><a href="02-zsh.html">zsh導入</a></li>
    <li><a href="02-ntpd.html">日付設定</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>Webサーバー構築</h3>
<ul class="menu">
    <li><a href="03-virtualhost.html">バーチャルホスト設定</a></li>
    <li><a href="03-htdigest.html">認証ページ作成</a></li>
    <li><a href="03-ssl.html">SSL通信</a></li>
    <li><a href="03-fcgi.html">FCGI</a></li>
    <li><a href="03-memcache.html">mamcache</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>メールサーバー構築</h3>
<ul class="menu">
    <li><a href="04-postfix.html">Postifx</a></li>
    <li><a href="04-dovecot.html">dovecot</a></li>
    <li><a href="04-mailx.html">mailコマンド導入</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>セキュリティ強化</h3>
<ul class="menu">
    <li><a href="05-tripwire.html">Tripwire</a></li>
    <li><a href="05-chkrootkit.html">chkrootkit</a></li>
    <li><a href="05-snort.html">Snort + Oinkmaster</a></li>
    <li><a href="05-swatch.html">SWATCH</a></li>
    <li><a href="05-clam.html">Clam AntiVirus</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>DBサーバー構築</h3>
<ul class="menu">
    <li><a href="06-mysql.html">MySQL導入</a></li>
    <li><a href="06-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>開発者向けツール導入</h3>
<ul class="menu">
    <li><a href="07-subversion.html">subversion</a></li>
    <li><a href="07-trac.html">Trac</a></li>
    <li><a href="07-hotcopy_svn_trac.html">Trac & SVN バックアップ</a></li>
    <li><a href="07-git.html">git</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>バックアップ強化</h3>
<ul class="menu">
    <li><a href="08-backup.html">自動バックアップ</a></li>
    <li><a href="08-subversion.html">MySQL導入</a></li>
    <li><a href="08-cwRsync.html">rsyncクライアント導入</a></li>
    <li><a href="08-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

			</div>
		    <div id="content">
		        <h1 id="自動バックアップ">自動バックアップ</h1>
<p id="description">バックアップ対象ディレクトリを、tarコマンドで圧縮してバックアップ先ディレクトリへ保存します。</p>
<h2 id="bzip2コマンドを取得">bzip2コマンドを取得</h2>
<p>
yum -y install bzip2
</p>
<p>
== バックアップスクリプト作成 == 
</p>
<p>
バックアップスクリプトを作成します。
</p>
<pre class="wiki">
% sudo vi /root/backup.sh
</pre>
<p>
下記内容を記述します。
</p>
<pre class="wiki">
#!/bin/bash

#
# ローカル内でバックアップ
#

LANG=C

#
# 設定開始
#
# バックアップ対象リスト名
# ※バックアップ対象をフルパスで記述したリスト
BACKUPLIST=/root/backuplist
[ ! -s $BACKUPLIST ] &amp;&amp; echo &quot;$BACKUPLIST is not found&quot; &amp;&amp; error_exit
# バックアップ対象外リスト名
# ※バックアップ対象外をフルパスで記述したリスト
BACKUPNOLIST=/root/backupnolist

# バックアップ先ディレクトリ名
BACKUPDIR=/backup
mkdir -p $BACKUPDIR

# バックアップ保存世代数
# ※当日分を含めた過去分バックアップを保存する世代数
# ※過去分バックアップを保存しない場合は1を指定する
BACKUPGEN=8
# 暗号化・復号化パスフレーズ
# ※指定がないときは暗号化しない
PASS=''
# バックアップログファイル名
BACKUPLOG=/var/log/backup.log
#
# 設定終了
#
# 異常終了処理関数定義
error_exit () {
    rm -f $TMPBACKUPNOLIST
    exit 1
}
# バックアップファイルをバックアップ対象外リストに追加
# ※バックアップ先ファイルをバックアップしないようにする
TMPBACKUPNOLIST=`mktemp`
[ -s $BACKUPNOLIST ] &amp;&amp; cat $BACKUPNOLIST &gt; $TMPBACKUPNOLIST
echo &quot;$BACKUPDIR/*backup.tar.bz2&quot; &gt;&gt; $TMPBACKUPNOLIST
# 前回バックアップをリネーム
cd $BACKUPDIR
OLDBACKUPFILE=`ls backup.tar.bz2* 2&gt;/dev/null`
if [ -f $OLDBACKUPFILE ]; then
    TIMESTAMP=`ls --full-time $OLDBACKUPFILE|awk '{print $6}'|tr -d -`
    mv $BACKUPDIR/$OLDBACKUPFILE $BACKUPDIR/${TIMESTAMP}$OLDBACKUPFILE &gt; /dev/null 2&gt;&amp;1
fi
# バックアップログファイル作成
rm -f $BACKUPLOG
touch $BACKUPLOG
chmod 400 $BACKUPLOG
# バックアップ実行
echo &quot;`date` backup start&quot; &gt;&gt; $BACKUPLOG
tar cjvfP $BACKUPDIR/backup.tar.bz2 -T $BACKUPLIST -X $TMPBACKUPNOLIST &gt;&gt; $BACKUPLOG 2&gt;&amp;1
code=$?
if [ $code -ne 0 ]; then
    cat $BACKUPLOG | mail -s &quot;BACKUP NG CODE IS $code&quot; root
    rm -f $BACKUPDIR/backup.tar.bz2
    error_exit
fi
echo &quot;`date` backup end&quot; &gt;&gt; $BACKUPLOG

# バックアップ暗号化(暗号化・復号化パスフレーズ指定時のみ)
if [ ! -z $PASS ]; then
    echo &quot;`date` encrypt start&quot; &gt;&gt; $BACKUPLOG
    mkdir -p $HOME/.gnupg
    echo $PASS|gpg --passphrase-fd 0 --batch -c $BACKUPDIR/backup.tar.bz2 &gt; /dev/null 2&gt;&amp;1
	code=$?
	if [ $code -ne 0 ]; then
	    cat $BACKUPLOG | mail -s &quot;BACKUP NG CODE IS $code&quot; root
	    rm -f $BACKUPDIR/backup.tar.bz2*
	    error_exit
	fi
    rm -f $BACKUPDIR/backup.tar.bz2
    echo &quot;`date` encrypt end&quot; &gt;&gt; $BACKUPLOG
fi

# バックアップ保存世代を超えた古いバックアップを削除
if [ $(ls $BACKUPDIR/*backup.tar.bz2*|wc -l) -gt $BACKUPGEN ]; then
    OLDBACKUPCNT=`expr $(ls $BACKUPDIR/*backup.tar.bz2*|wc -l) - $BACKUPGEN`
    for file in `ls -t $BACKUPDIR/*backup.tar.bz2*|tail -n $OLDBACKUPCNT`
    do
        rm -f $file
    done
fi

# バックアップ対象外リスト削除
rm -f $TMPBACKUPNOLIST
</pre>
<p>
実行権限を付与
</p>
<pre class="wiki">
% sudo chmod +x /root/backup.sh
</pre>
<h2 id="バックアップ対象リスト作成">バックアップ対象リスト作成</h2>
<pre class="wiki">
% sudo su
# echo &quot;/mysql_backup&quot; &gt;&gt; /root/backuplist
</pre>
<h2 id="cronに登録">cronに登録</h2>
<pre class="wiki">
# echo &quot;0 5 * * * root /root/backup.sh&quot; &gt;&gt; /etc/crontab
</pre>

		    </div>
			<br class="clear" />
			<div id="footer">
				<p>
					<a href="http://linode.jp">Linode</a> | 
					<a href="http://www.add9.biz/phpunit">PHPUnit</a> | 
					<a href="http://www.add9.biz/symfony">Symfony</a>
					<br />
				
					<a href="http://www.add9.biz/c">C</a> | 
					<a href="http://www.add9.biz/moose">Moose</a> | 
					<a href="http://www.add9.biz/design_pattern">Design Pattern</a>
					<br />

					<a href="http://www.add9.biz/jump">Jump Attack Forum</a> | 
					<a href="http://dancepod.tv">DancePod.tv</a>
				</p>
			</div>
	    </div>
		<div id="adsence">
			<script type="text/javascript"><!--
			google_ad_client = "pub-3627018862025650";
			google_ad_slot = "0294735282";
			google_ad_width = 160;
			google_ad_height = 600;
			//-->
			</script>
			<script type="text/javascript"
			src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
			</script>
		</div>
	</div>
	<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
	try {
	var pageTracker = _gat._getTracker("UA-7965172-1");
	pageTracker._trackPageview();
	} catch(err) {}</script>
</body>
</html>
