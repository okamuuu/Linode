<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf8" />
    <title>SWATCH | How to Linode</title>
    <meta name="keywords" content="" />
    <meta name="description" content="システムのログファイルを監視し、特定のメッセージを検知します。任意のアクションを実行するSWATCHを導入します。" />
    <meta name="robots" content="all" />

    <link rel="stylesheet" type="text/css" media="screen" href="../common/css/import.css"/>
</head>
<body>
	<div id="wrapper">
		<div id="wrap">
			<div id="header">
				<p id="title"><a href="/">How to Linode</a></p>
			</div>
<!-- category[start] -->
<ul id="tab">
<li><a href="/" class="home">HOME</a></li>
<li><a href="/centos53/" class="centos53 current">CentOS5.3</a></li>
<li><a href="/debian50/" class="debian50">Debian5.0</a></li>
</ul>
<!-- category[end] -->

<!-- bread[start] -->
<p id="bread">
<a href="/">home</a> &gt;
SWATCH
</p>
<!-- bread[end] -->

			<div id="side-bar">
<!-- menu[start] -->
<h3>初期設定</h3>
<ul class="menu">
    <li><a href="index.html">OS起動</a></li>
    <li><a href="02-ssh.html">OpenSSH設定</a></li>
    <li><a href="02-yum.html">yum最適化</a></li>
    <li><a href="02-sudo.html">sudo導入</a></li>
    <li><a href="02-vim.html">vi拡張</a></li>
    <li><a href="02-screen.html">screen導入</a></li>
    <li><a href="02-zsh.html">zsh導入</a></li>
    <li><a href="02-ntpd.html">日付設定</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>Webサーバー構築</h3>
<ul class="menu">
    <li><a href="03-virtualhost.html">バーチャルホスト設定</a></li>
    <li><a href="03-htdigest.html">認証ページ作成</a></li>
    <li><a href="03-ssl.html">SSL通信</a></li>
    <li><a href="03-fcgi.html">FCGI</a></li>
    <li><a href="03-memcache.html">mamcache</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>メールサーバー構築</h3>
<ul class="menu">
    <li><a href="04-postfix.html">Postifx</a></li>
    <li><a href="04-dovecot.html">dovecot</a></li>
    <li><a href="04-mailx.html">mailコマンド導入</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>セキュリティ強化</h3>
<ul class="menu">
    <li><a href="05-tripwire.html">Tripwire</a></li>
    <li><a href="05-chkrootkit.html">chkrootkit</a></li>
    <li><a href="05-snort.html">Snort + Oinkmaster</a></li>
    <li><a href="05-swatch.html">SWATCH</a></li>
    <li><a href="05-clam.html">Clam AntiVirus</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>DBサーバー構築</h3>
<ul class="menu">
    <li><a href="06-mysql.html">MySQL導入</a></li>
    <li><a href="06-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>開発者向けツール導入</h3>
<ul class="menu">
    <li><a href="07-subversion.html">subversion</a></li>
    <li><a href="07-trac.html">Trac</a></li>
    <li><a href="07-hotcopy_svn_trac.html">Trac & SVN バックアップ</a></li>
    <li><a href="07-git.html">git</a></li>
</ul>
<!-- menu[end] -->

<!-- menu[start] -->
<h3>バックアップ強化</h3>
<ul class="menu">
    <li><a href="08-backup.html">自動バックアップ</a></li>
    <li><a href="08-subversion.html">MySQL導入</a></li>
    <li><a href="08-cwRsync.html">rsyncクライアント導入</a></li>
    <li><a href="08-mysql_backup.html">MySQLバックアップ</a></li>
</ul>
<!-- menu[end] -->

			</div>
		    <div id="content">
		        <h1 id="SWATCH">SWATCH</h1>
<p id="description">システムのログファイルを監視し、特定のメッセージを検知します。<br />任意のアクションを実行するSWATCHを導入します。</p>
<h2 id="インストール">インストール</h2>
<p>
RPMforgeリポジトリを参照してyumインストール
</p>
<pre class="wiki">
% sudo yum -y --enablerepo=rpmforge install swatch
</pre>
<h2 id="設定">設定</h2>
<h3 id="SWATCHアクションスクリプト作成">SWATCHアクションスクリプト作成</h3>
<p>
SWATCHが検知したIPアドレスからの累積不正アクセス数が3回以上になった場合または、引数でlock※と指定された場合、該当IPアドレスからのアクセスを24時間規制するシェルスクリプトを作成します。
</p>
<p>
アクションスクリプトを作成
</p>
<pre class="wiki">
% sudo vi /root/swatch_action.sh
</pre>
<p>
下記内容を記述
</p>
<pre class="wiki">
#!/bin/bash
PATH=/bin:/sbin:/usr/bin
LANG=C

# 規制IPアドレス情報メール通知先設定
# ※メール通知しない場合は下記をコメントアウト
mail=root

# ログを標準入力から取得
read LOG

# ログからIPアドレスを抽出
IPADDR=`echo $LOG|cut -d &quot; &quot; -f $1`
echo &quot;$IPADDR&quot;|grep &quot;^[0-9]*\.&quot; &gt; /dev/null 2&gt;&amp;1
if [ $? -eq 0 ]; then
    # IPアドレスから始まる場合
    IPADDR=`echo &quot;$IPADDR&quot;|sed -e 's/\([0-9]*\.[0-9]*\.[0-9]*\.[0-9]*\).*/\1/p' -e d`
else
    # IPアドレス以外から始まる場合
    IPADDR=`echo &quot;$IPADDR&quot;|sed -e 's/.*[^0-9]\([0-9]*\.[0-9]*\.[0-9]*\.[0-9]*\).*/\1/p' -e d`
fi

# IPアドレスをピリオドで分割
addr1=`echo $IPADDR|cut -d . -f 1`
addr2=`echo $IPADDR|cut -d . -f 2`
addr3=`echo $IPADDR|cut -d . -f 3`
addr4=`echo $IPADDR|cut -d . -f 4`

# IPアドレスがプライベートIPアドレスの場合は終了
if [ &quot;$IPADDR&quot; = &quot;127.0.0.1&quot; ]; then
    exit
elif [ $addr1 -eq 10 ]; then
    exit
elif [ $addr1 -eq 172 ] &amp;&amp; [ $addr2 -ge 16 ] &amp;&amp; [ $addr2 -le 31 ]; then
    exit
elif [ $addr1 -eq 192 ] &amp;&amp; [ $addr2 -eq 168 ]; then
    exit
fi

# 不正アクセスログメッセージをIPアドレス別ログファイルに記録
echo $LOG &gt;&gt; /var/log/swatch/$IPADDR

# IPアドレス別ログファイルから累積不正アクセス数取得
cnt=`cat /var/log/swatch/$IPADDR | wc -l`

# 該当IPアドレスからの累積不正アクセス数が3以上の場合または
# 引数でlockと指定された場合アクセス規制
if [ $cnt -ge 3 ] || [ $# -eq 2 -a  &quot;$2&quot; = &quot;lock&quot; ]; then
    # 該当IPアドレスからのアクセスを拒否するルールを挿入
    iptables -I INPUT -s $IPADDR -j DROP
    # 上記ルールを24時間後に削除するスケジュールを登録
    echo &quot;iptables -D INPUT -s $IPADDR -j DROP &gt; /dev/null 2&gt;&amp;1&quot; | \
    at now+24hour &gt; /dev/null 2&gt;&amp;1
    # アクセス規制IPアドレス情報をメール通知
    [ &quot;$mail&quot; != &quot;&quot; ] &amp;&amp; (cat /var/log/swatch/$IPADDR ; \
                          echo ; whois $IPADDR) | \
                          mail -s &quot;$IPADDR $cnt lock!&quot; $mail
    echo &quot;`date` $IPADDR $cnt lock!&quot;
else
    echo &quot;`date` $IPADDR $cnt&quot;
fi
</pre>
<p>
実行権限を付与
</p>
<pre class="wiki">
% sudo chmod 700 /root/swatch_action.sh
</pre>
<h2 id="SWATCH設定">SWATCH設定</h2>
<p>
SWATCH設定ファイル格納ディレクトリ作成
</p>
<pre class="wiki">
% sudo mkdir /etc/swatch
</pre>
<p>
SWATCHログ切替え設定ファイル作成
</p>
<pre class="wiki">
% sudo vi /etc/logrotate.d/swatch
</pre>
<p>
下記内容を記述
</p>
<pre class="wiki">
/var/log/swatch/swatch.log {
    missingok
    notifempty
    sharedscripts
    postrotate
        /etc/rc.d/init.d/swatch restart &gt; /dev/null || true
    endscript
}
</pre>
<h3 id="/var/log/secure監視設定">/var/log/secure監視設定</h3>
<p>
以下のメッセージを検知したら該当ホストからのアクセスを24時間規制するようにする
</p>
<pre class="wiki">
Jan 24 09:32:07 centos sshd[21171]: refused connect from ::ffff:XXX.XXX.XXX.XXX (::ffff:XXX.XXX.XXX.XXX)
</pre>
<p>
以下のメッセージを3回以上検知したら該当ホストからのアクセスを24時間規制するようにする
</p>
<pre class="wiki">
Jan 28 19:32:10 centos sshd[16367]: Invalid user admin from XXX.XXX.XXX.XXXOct 21 05:20:12 centos named[14130]: client XXX.XXX.XXX.XXX#55199: query 'VERSION.BIND/TXT/CH' denied
</pre>
<p>
監視用設定ファイル作成
</p>
<pre class="wiki">
% sudo vi /etc/swatch/secure.conf
</pre>
<p>
下記内容を記述します。
</p>
<pre class="wiki">
# logfile /var/log/secure
# アクセス無許可ホストからのSSHログイン失敗を検知したら該当ホストからのアクセスを24時間規制
# ※/etc/hosts.deny、/etc/hosts.allowでアクセス許可ホストを制限していることが前提
watchfor /sshd.*refused/
    pipe &quot;/root/swatch_action.sh 10 lock&quot;
    throttle=00:00:10
# アクセス許可ホストからのSSHログイン失敗を3回以上検知したら該当ホストからのアクセスを24時間規制
watchfor /sshd.*Invalid user/
    pipe &quot;/root/swatch_action.sh 10&quot;
    throttle=00:00:10
</pre>
<h2 id="SWATCH起動">SWATCH起動</h2>
<p>
起動スクリプトを作成
</p>
<pre class="wiki">
% sudo vi /etc/rc.d/init.d/swatch
</pre>
<p>
下記内容を記述
</p>
<pre class="wiki">
#!/bin/bash
#
# swatch
#
# chkconfig: 2345 90 35
# description: swatch start/stop script
# Source function library.
. /etc/rc.d/init.d/functions

PATH=/sbin:/usr/local/bin:/bin:/usr/bin
mkdir -p /var/log/swatch
start() {
    # Start daemons.
    ls /var/run/swatch_*.pid &gt; /dev/null 2&gt;&amp;1
    if [ $? -ne 0 ]; then
        echo -n &quot;Starting swatch&quot;
        pno=0
        for conf in /etc/swatch/*.conf
        do
            pno=`expr $pno + 1`
            WATCHLOG=`grep &quot;^# logfile&quot; $conf | awk '{ print $3 }'`
            swatch --config-file $conf --tail-file $WATCHLOG \
            --script-dir=/tmp --awk-field-syntax --use-cpan-file-tail --daemon \
            --pid-file /var/run/swatch_$pno.pid \
            &gt;&gt; /var/log/swatch/swatch.log 2&gt;&amp;1
            RETVAL=$?
            [ $RETVAL != 0 ] &amp;&amp; return $RETVAL
        done
        echo
        [ $RETVAL = 0 ] &amp;&amp; touch /var/lock/subsys/swatch
        return $RETVAL
    else
        echo &quot;swatch is already started&quot;
    fi
}
stop() {
    # Stop daemons.
    ls /var/run/swatch_*.pid &gt; /dev/null 2&gt;&amp;1
    if [ $? -eq 0 ]; then
        echo -n &quot;Shutting down swatch&quot;
        for pid in /var/run/swatch_*.pid
        do
           kill $(cat $pid)
           rm -f $pid
        done
        echo
        rm -f /var/lock/subsys/swatch /tmp/.swatch_script.*
    else
        echo &quot;swatch is not running&quot;
    fi
}
status() {
    ls /var/run/swatch_*.pid &gt; /dev/null 2&gt;&amp;1
    if [ $? -eq 0 ]; then
        echo -n &quot;swatch (pid&quot;
        for pid in /var/run/swatch_*.pid
        do
           echo -n &quot; `cat $pid`&quot;
        done
        echo &quot;) is running...&quot;
    else
        echo &quot;swatch is stopped&quot;
    fi
}
case &quot;$1&quot; in
  start)
        start
        ;;
  stop)
        stop
        ;;
  restart)
        stop
        start
        ;;
  status)
        status
        ;;
   *)
        echo &quot;Usage: swatch {start|stop|restart|status}&quot;
        exit 1
esac
exit $RETVAL
</pre>
<p>
実行権限を付与
</p>
<pre class="wiki">
% sudo chmod +x /etc/rc.d/init.d/swatch
</pre>
<p>
SWATCH起動
</p>
<pre class="wiki">
% sudo /etc/rc.d/init.d/swatch start
</pre>
<p>
chkconfigに登録
</p>
<pre class="wiki">
% sudo /sbin/chkconfig --add swatch
% sudo /sbin/chkconfig swatch on
% sudo /sbin/chkconfig --list swatch
</pre>

		    </div>
			<br class="clear" />
			<div id="footer">
				<p>
					<a href="http://linode.jp">Linode</a> | 
					<a href="http://www.add9.biz/phpunit">PHPUnit</a> | 
					<a href="http://www.add9.biz/symfony">Symfony</a>
					<br />
				
					<a href="http://www.add9.biz/c">C</a> | 
					<a href="http://www.add9.biz/moose">Moose</a> | 
					<a href="http://www.add9.biz/design_pattern">Design Pattern</a>
					<br />

					<a href="http://www.add9.biz/jump">Jump Attack Forum</a> | 
					<a href="http://dancepod.tv">DancePod.tv</a>
				</p>
			</div>
	    </div>
		<div id="adsence">
			<script type="text/javascript"><!--
			google_ad_client = "pub-3627018862025650";
			google_ad_slot = "0294735282";
			google_ad_width = 160;
			google_ad_height = 600;
			//-->
			</script>
			<script type="text/javascript"
			src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
			</script>
		</div>
	</div>
	<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
	try {
	var pageTracker = _gat._getTracker("UA-7965172-1");
	pageTracker._trackPageview();
	} catch(err) {}</script>
</body>
</html>
