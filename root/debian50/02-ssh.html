<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf8" />
    <title>SSHのログオンユーザーを制限 | How to Linode</title>
    <meta name="keywords" content="OpenSSH" />
    <meta name="description" content="ネットワーク制限とあわせて、ユーザー制限を行いセキュリティを強化します。" />
    <meta name="robots" content="all" />

    <link rel="stylesheet" type="text/css" media="screen" href="../common/css/import.css"/>
</head>
<body>
	<div id="wrapper">
		<div id="wrap">
			<div id="header">
				<p id="title"><a href="/">How to Linode</a></p>
			</div>
<!-- category[start] -->
<ul id="tab">
<li><a href="/" class="home">HOME</a></li>
<li><a href="/centos53/" class="centos53">CentOS5.3</a></li>
<li><a href="/debian50/" class="debian50 current">Debian5.0</a></li>
</ul>
<!-- category[end] -->

<!-- bread[start] -->
<p id="bread">
<a href="/">home</a> &gt;
SSHのログオンユーザーを制限
</p>
<!-- bread[end] -->

			<div id="side-bar">
<!-- menu[start] -->
<h3>初期設定</h3>
<ul class="menu">
    <li><a href="index.html">接続元ネットワークを制限する</a></li>
    <li><a href="02-ssh.html">SSHのログオンユーザーを制限</a></li>
    <li><a href="02-sudo.html">sudo導入</a></li>
    <li><a href="02-vim.html">vi拡張</a></li>
    <li><a href="02-screen.html">screen導入</a></li>
    <li><a href="02-zsh.html">zsh導入</a></li>
    <li><a href="02-ntpd.html">日付設定</a></li>
    <li><a href="02-service_all.html">サービス確認</a></li>
</ul>
<!-- menu[end] -->

			</div>
		    <div id="content">
		        <h1 id="SSHのログオンユーザーを制限">SSHのログオンユーザーを制限</h1>
<p id="description">ネットワーク制限とあわせて、ユーザー制限を行いセキュリティを強化します。</p>
<h2 id="作業概要">作業概要</h2>
<ul><li>OpenSSHの最新番をインストール
</li><li>ルートユーザーでのSSHを禁止
</li><li>認証方法をパスワード方式から鍵認証へ変更</li></ul>
<h2 id="インストール">インストール</h2>
<p>
<em>OpenSSH</em>をインストールします。
</p>
<pre class="wiki">
$ sudo update
$ sudo aptitude install -y openssh-server
</pre>
<h2 id="rootユーザーでのリモートログインを禁止する">rootユーザーでのリモートログインを禁止する</h2>
<p>
作業対象となるファイルを開きます。
</p>
<pre class="wiki">
# vim /etc/ssh/sshd_config
</pre>
<p>
以下の項目を次の様に設定します。
</p>
<pre class="wiki">
PermitRootLogin no
PermitEmptyPasswords no
</pre>
<p>
ssh再起動
</p>
<pre class="wiki">
# /etc/init.d/ssh restart
</pre>
<p>
homepageユーザーを使ってログインし直します。
</p>
<h2 id="認証方法をパスワード方式から鍵認証へ変更">認証方法をパスワード方式から鍵認証へ変更</h2>
<ul><li>秘密鍵を作成
</li><li>秘密鍵を移動
</li><li>鍵認証でのログイン認証に切り替える。</li></ul>
<p>
※この作業は一般ユーザーでログインし直した状態を想定して説明します。
</p>
<p>
鍵作成 
</p>
<pre class="wiki">
$ mkdir ~/.ssh
$ cd ~/.ssh
$ ssh-keygen -t dsa
...
</pre>
<p>
ssh-keygenを実行した後は次のように回答します。
パスフレーズを空にしているのは後日自動実行スクリプトでの作業を
想定している為です。
</p>
<pre class="wiki">
Generating public/private dsa key pair.
Enter file in which to save the key (/home/homepage/.ssh/id_dsa): ←[空エンター]
Enter passphrase (empty for no passphrase): ←[空エンター]
Enter same passphrase again: ←[空エンター]
Your identification has been saved in /home/homepage/.ssh/id_dsa.
Your public key has been saved in /home/homepage/.ssh/id_dsa.pub.
The key fingerprint is:
00:f6:ba:11:39:7b:76:1f:40:85:9f:73:0c:ea:e7:be homepage@SCYLLA-01
The key's randomart image is:
</pre>
<p>
※パスワードを設定していたほうが安全かもしれませんが、そもそも鍵が流出した時点で
すでにそのパスワードは時間稼ぎ程度の気休めにしか過ぎない、という前提です。
</p>
<p>
公開鍵を authorized_keys へ追加
</p>
<pre class="wiki">
$ cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys
$ chmod 600 ~/.ssh/authorized_keys
</pre>
<p>
作成した秘密鍵をWinSCPなどでダウンロードします。
秘密鍵はこのファイルです。
</p>
<pre class="wiki">
 ~/.ssh/id_dsa
</pre>
<p>
Putty-Genで読み込み、Puttyでも利用できる形式に変換します。
</p>
<p>
この結果できた秘密鍵と公開鍵を使用しないと将来的に踏み台サーバー
を設置する際などに鍵の形式が合わない事による不都合が生じるかもしれません。
</p>
<p>
なお、今回の手順はネットワーク越しに鍵を映しているのでセキュリティ的に問題があるのかもしれませんが、手軽にSSHの設定をする一つの手段として紹介しております。この手順で不都合が生じた場合があったとしても、当方は一切関知しません。
</p>
<p>
公開鍵を配置し、パーミッションを変更する。
</p>
<pre class="wiki">
$ cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys
$ chmod 700 ~/.ssh
$ chmod 600 ~/.ssh/authorized_keys
</pre>
<p>
公開鍵はこの時点で必要はないので削除します。
</p>
<pre class="wiki">
$ rm ~/.ssh/id_dsa.pub
</pre>
<p>
認証方式をパスワード方式から鍵方式へ変更します。
</p>
<pre class="wiki">
$ su 
# vim /etc/ssh/sshd_config
</pre>
<pre class="wiki">
PasswordAuthentication no
</pre>
<p>
再起動
</p>
<pre class="wiki">
# /etc/init.d/ssh restart

</pre>
<h2 id="確認">確認</h2>
<p>
ログを監視
</p>
<pre class="wiki">
# tail -f /var/log/auth.log
</pre>
<p>
この状態でroot権限でログインできない事を確認します。次のようなログが表示され、ログインに失敗する事を確認します。
</p>
<pre class="wiki">
No supported authentication methods available
</pre>
<p>
次に一般ユーザーで鍵認証方式でログインできているかを確認します。次のようなログが表示されている事を確認して下さい。
</p>
<pre class="wiki">
Accepted publickey for homepage from xxx.xxx.xxx.xxx port 
</pre>

		    </div>
			<br class="clear" />
			<div id="footer">
				<p>
					<a href="http://linode.jp">Linode</a> | 
					<a href="http://www.add9.biz/phpunit">PHPUnit</a> | 
					<a href="http://www.add9.biz/symfony">Symfony</a>
					<br />
				
					<a href="http://www.add9.biz/c">C</a> | 
					<a href="http://www.add9.biz/moose">Moose</a> | 
					<a href="http://www.add9.biz/design_pattern">Design Pattern</a>
					<br />

					<a href="http://www.add9.biz/jump">Jump Attack Forum</a> | 
					<a href="http://dancepod.tv">DancePod.tv</a>
				</p>
			</div>
	    </div>
		<div id="adsence">
			<script type="text/javascript"><!--
			google_ad_client = "pub-3627018862025650";
			google_ad_slot = "0294735282";
			google_ad_width = 160;
			google_ad_height = 600;
			//-->
			</script>
			<script type="text/javascript"
			src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
			</script>
		</div>
	</div>
	<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
	try {
	var pageTracker = _gat._getTracker("UA-7965172-1");
	pageTracker._trackPageview();
	} catch(err) {}</script>
</body>
</html>
